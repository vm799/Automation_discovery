<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discovery Sales Tool ‚Äî AI & Automation Consultant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0f172a;
            --secondary: #1e293b;
            --accent: #3b82f6;
            --accent-light: #60a5fa;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --border: #334155;
            --bg-light: #1e293b;
            --bg-lighter: #0f172a;
            --shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, #1a1f36 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* HEADER / TOP NAV */
        header {
            background: var(--secondary);
            border-bottom: 1px solid var(--border);
            padding: 20px 0;
            margin-bottom: 30px;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background-color: rgba(30, 41, 59, 0.9);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--bg-light);
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* MAIN LAYOUT */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        /* CARDS */
        .card {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card:hover {
            border-color: var(--accent);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.2);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--accent-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* FORM ELEMENTS */
        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* CHECKBOXES & RADIO */
        .checkbox-group,
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-item,
        .radio-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover,
        .radio-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        input[type="checkbox"],
        input[type="radio"] {
            accent-color: var(--accent);
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .checkbox-item label,
        .radio-item label {
            cursor: pointer;
            margin: 0;
            font-size: 14px;
            font-weight: normal;
            text-transform: none;
        }

        /* BUTTONS */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 8px 14px;
            font-size: 12px;
        }

        /* PROGRESS */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-light) 100%);
            transition: width 0.3s ease;
        }

        /* SLIDERS */
        .slider-container {
            margin: 20px 0;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
        }

        /* DASHBOARD */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        .dashboard-card h3 {
            font-size: 13px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .dashboard-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .dashboard-card .subtext {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* CALL LOG TABLE */
        .call-log-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .call-log-table thead {
            background: var(--bg-light);
        }

        .call-log-table th {
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .call-log-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        .call-log-table tbody tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        /* MODALS */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: var(--accent-light);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 24px;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: var(--text);
        }

        /* ALERTS */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid;
            font-size: 13px;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
            color: var(--success);
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* OPPORTUNITIES */
        .opportunity {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .opportunity:hover {
            border-color: var(--accent);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.15);
        }

        .opportunity-rank {
            display: inline-flex;
            background: var(--accent);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 10px;
        }

        /* DOCUMENTS */
        .document-item {
            background: var(--bg-light);
            border: 1px dashed var(--border);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .document-item:hover {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.05);
        }

        .document-info h4 {
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--accent-light);
        }

        .document-info p {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* UTILITY */
        .mb-20 {
            margin-bottom: 20px;
        }

        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .gap-10 {
            gap: 10px;
        }

        /* TEMPLATE CARDS */
        .template-card:hover {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.05);
            transform: translateY(-2px);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 20px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- jsPDF for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="header-content">
            <div class="logo">üöÄ Discovery Pro</div>
            <div class="nav-right">
                <a href="index.html" class="nav-btn">‚Üê Portfolio</a>
                <a href="scorecard.html" class="nav-btn" style="background: linear-gradient(135deg, #00d9ff 0%, #8b5cf6 100%); color: white;">üìà AI Scorecard</a>
                <button class="nav-btn" id="btn-dashboard" data-action="showDashboard">üìä Dashboard</button>
                <button class="nav-btn" id="btn-crm" data-action="showCRM">üìá CRM</button>
                <button class="nav-btn" id="btn-followup" data-action="showFollowUpView">‚úâÔ∏è Follow-Ups</button>
                <button class="nav-btn" id="btn-calendar" data-action="showCalendarView">üìÖ Calendar</button>
                <button class="nav-btn" id="btn-reset" data-action="resetAll" style="color: #ef4444;">‚Üª Reset</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- MAIN DISCOVERY FLOW -->
        <div id="discovery-flow">
            <div class="main-layout">
                <!-- LEFT SIDE: INPUT FORM -->
                <div>
                    <!-- PROGRESS -->
                    <div class="card">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                        <p style="font-size: 12px; color: var(--text-muted); text-align: center;">
                            <span id="step-counter">Step 1</span> of 5
                        </p>
                    </div>

                    <!-- STEP 1: COMPANY BASICS -->
                    <div class="card" id="step-1">
                        <h2>üìã Company Basics</h2>

                        <div class="form-group">
                            <label>Prospect Name *</label>
                            <input type="text" id="prospect-name" placeholder="e.g., Sarah Chen" required>
                        </div>

                        <div class="form-group">
                            <label>Email Address *</label>
                            <input type="email" id="prospect-email" placeholder="e.g., sarah@company.com" required>
                        </div>

                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="prospect-phone" placeholder="e.g., +1 (555) 123-4567">
                        </div>

                        <div class="form-group">
                            <label>Company Name *</label>
                            <input type="text" id="company-name" placeholder="e.g., Local Physio Clinic" required>
                        </div>

                        <div class="form-group">
                            <label>Role / Title</label>
                            <select id="prospect-role">
                                <option value="">Select...</option>
                                <option value="Owner">Owner</option>
                                <option value="Director">Director</option>
                                <option value="Manager">Manager</option>
                                <option value="VP">VP / Executive</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Industry</label>
                            <select id="industry">
                                <option value="">Select...</option>
                                <option value="Healthcare">Healthcare / Wellness</option>
                                <option value="Finance">Finance / Accounting</option>
                                <option value="Legal">Legal Services</option>
                                <option value="Professional Services">Professional Services</option>
                                <option value="Recruiting">Recruiting / HR</option>
                                <option value="Retail">Retail / E-commerce</option>
                                <option value="Tech">Tech / SaaS</option>
                                <option value="Manufacturing">Manufacturing</option>
                                <option value="Logistics">Logistics</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Company Size</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="size-1" name="company-size" value="1-10">
                                    <label for="size-1">1-10 people</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="size-2" name="company-size" value="11-50">
                                    <label for="size-2">11-50 people</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="size-3" name="company-size" value="51-200">
                                    <label for="size-3">51-200 people</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="size-4" name="company-size" value="200+">
                                    <label for="size-4">200+ people</label>
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-primary" class="btn-step-continue" data-action="nextStep">Continue ‚Üí</button>
                    </div>

                    <!-- STEP 2: CURRENT STATE & PAIN POINTS -->
                    <div class="card hidden" id="step-2">
                        <h2>üéØ Pain Points & Goals</h2>

                        <div class="form-group">
                            <label>Current State (in their words)</label>
                            <textarea id="current-state" placeholder="What does a typical week look like? Describe your business..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>Primary Pain Category</label>
                            <select id="pain-category" onchange="app.populatePainCheckboxes()">
                                <option value="">Select...</option>
                                <option value="Lead Generation">Lead Generation & Marketing</option>
                                <option value="Sales">Sales & Follow-up</option>
                                <option value="Customer Service">Customer Service & Support</option>
                                <option value="Operations">Operations & Delivery</option>
                                <option value="Finance">Finance & Admin</option>
                                <option value="HR">HR & Hiring</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Specific Pain Points (select all that apply)</label>
                            <div class="checkbox-group" id="pain-checkboxes">
                                <!-- Dynamically populated -->
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Root Cause (why is this happening?)</label>
                            <textarea id="root-cause" placeholder="What's the underlying cause of this problem?"></textarea>
                        </div>

                        <div class="flex gap-10">
                            <button class="btn btn-secondary" class="btn-step-back" data-action="prevStep">‚Üê Back</button>
                            <button class="btn btn-primary" class="btn-step-continue" data-action="nextStep">Continue ‚Üí</button>
                        </div>
                    </div>

                    <!-- STEP 3: TECHNOLOGY AUDIT -->
                    <div class="card hidden" id="step-3">
                        <h2>üîß Technology Stack</h2>

                        <div class="form-group">
                            <label>Current Tools (A‚ÜíZ)</label>
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px;">
                                List all tools you currently use. Type and press Enter to add.
                            </p>
                            <input type="text" id="tool-input" placeholder="e.g., Salesforce, Google Sheets, Slack..." onkeypress="app.addTool(event)">
                            <div id="tools-list" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
                        </div>

                        <div class="form-group">
                            <label>Main Integration Gaps</label>
                            <textarea id="integration-gaps" placeholder="Which tools don't talk to each other? What's causing manual work?"></textarea>
                        </div>

                        <div class="flex gap-10">
                            <button class="btn btn-secondary" class="btn-step-back" data-action="prevStep">‚Üê Back</button>
                            <button class="btn btn-primary" class="btn-step-continue" data-action="nextStep">Continue ‚Üí</button>
                        </div>
                    </div>

                    <!-- STEP 4: DESIRED FUTURE STATE & METRICS -->
                    <div class="card hidden" id="step-4">
                        <h2>‚ú® Future Vision & Metrics</h2>

                        <div class="form-group">
                            <label>Desired Future State (what would winning look like?)</label>
                            <textarea id="future-state" placeholder="What does success look like in 6 months?"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Team Size Affected</label>
                            <input type="number" id="team-size" placeholder="e.g., 4" min="1" max="500" oninput="app.updateROI()">
                        </div>

                        <div class="form-group">
                            <label>Hours/Week Currently Spent on This Pain</label>
                            <input type="number" id="hours-per-week" placeholder="e.g., 15" min="0" max="168" oninput="app.updateROI()">
                        </div>

                        <div class="form-group">
                            <label>Average Deal/Transaction Value (if applicable)</label>
                            <input type="number" id="deal-value" placeholder="e.g., 800" min="0" oninput="app.updateROI()">
                        </div>

                        <div class="form-group">
                            <label>Volume Per Week</label>
                            <input type="number" id="volume-per-week" placeholder="e.g., 20" min="0" oninput="app.updateROI()">
                        </div>

                        <div class="form-group">
                            <label>Financial Impact (Monthly Revenue at Risk)</label>
                            <input type="number" id="revenue-at-risk" placeholder="e.g., 5000" min="0" oninput="app.updateROI()">
                        </div>

                        <div class="form-group">
                            <label>Impact Severity (1-10)</label>
                            <div class="slider-container">
                                <input type="range" id="severity-slider" min="1" max="10" value="5" oninput="document.getElementById('severity-value').textContent = this.value">
                                <div style="text-align: center; margin-top: 10px;">
                                    <span style="font-weight: bold; color: var(--accent);">Level <span id="severity-value">5</span>/10</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-10">
                            <button class="btn btn-secondary" class="btn-step-back" data-action="prevStep">‚Üê Back</button>
                            <button class="btn btn-primary" onclick="app.nextStep()">Generate Recommendations ‚Üí</button>
                        </div>
                    </div>

                    <!-- STEP 5: REVIEW & GENERATE -->
                    <div class="card hidden" id="step-5">
                        <h2>üìä Review & Generate</h2>

                        <div class="alert alert-info">
                            ‚úì All information collected. Ready to generate proposal documents.
                        </div>

                        <div class="form-group">
                            <label>Additional Notes</label>
                            <textarea id="additional-notes" placeholder="Any additional context or notes..."></textarea>
                        </div>

                        <div class="flex gap-10">
                            <button class="btn btn-secondary" class="btn-step-back" data-action="prevStep">‚Üê Back</button>
                            <button class="btn btn-success" onclick="app.generateProposal()">‚úì Generate All Documents</button>
                        </div>
                    </div>
                </div>

                <!-- RIGHT SIDE: REAL-TIME SUGGESTIONS & PREVIEW -->
                <div>
                    <!-- QUESTIONS SIDEBAR -->
                    <div class="card">
                        <h2>üí° Next Questions to Ask</h2>
                        <div id="questions-sidebar">
                            <p style="font-size: 13px; line-height: 1.6; color: var(--text-muted);">
                                Start filling in the company basics on the left. I'll suggest questions to deepen your discovery.
                            </p>
                        </div>
                    </div>

                    <!-- PATTERN DETECTION -->
                    <div class="card">
                        <h2>üîç Pattern Detection</h2>
                        <div id="patterns-sidebar">
                            <p style="font-size: 13px; color: var(--text-muted);">
                                As you input pain points, I'll identify patterns and suggest solution clusters.
                            </p>
                        </div>
                    </div>

                    <!-- ROI CALCULATOR -->
                    <div class="card">
                        <h2>üí∞ Quick ROI Estimate</h2>
                        <div id="roi-calculator">
                            <p style="font-size: 13px; color: var(--text-muted);">
                                Fill in metrics on the left. ROI will calculate automatically.
                            </p>
                        </div>
                    </div>

                    <!-- PROGRESSIVE SUMMARY -->
                    <div class="card" style="position: sticky; top: 20px;">
                        <h2 style="font-size: 16px; margin-bottom: 15px; color: var(--accent-light);">
                            üìã Live Summary
                        </h2>
                        <div id="progressiveSummary">
                            <p style="font-size: 13px; color: var(--text-muted);">
                                Summary will build as you fill in the discovery form...
                            </p>
                        </div>
                    </div>

                    <!-- ROI SUMMARY -->
                    <div class="card">
                        <h2 style="font-size: 16px; margin-bottom: 15px; color: var(--accent-light);">
                            üíµ ROI Estimate
                        </h2>
                        <div id="roiSummary">
                            <p style="font-size: 13px; color: var(--text-muted);">
                                Fill in metrics to see ROI...
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESULTS / PROPOSAL VIEW -->
        <div id="results-view" class="hidden">
            <div class="card mb-20">
                <h2>üìÑ Your Proposal</h2>
                <div class="flex gap-10" style="margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-primary btn-small" onclick="app.downloadProposalPDF()">üì• Proposal (PDF)</button>
                    <button class="btn btn-primary btn-small" onclick="app.downloadScopePDF()">üìã SOW (PDF)</button>
                    <button class="btn btn-primary btn-small" onclick="app.downloadContractPDF()">üìú Contract (PDF)</button>
                    <button class="btn btn-secondary btn-small" onclick="app.downloadProposal()">Download TXT</button>
                    <button class="btn btn-secondary btn-small" onclick="app.showEmailTemplate()">‚úâÔ∏è Email Template</button>
                    <button class="btn btn-secondary btn-small" onclick="app.backToDiscovery()">‚Üê Back to Discovery</button>
                </div>

                <div class="alert alert-success">
                    ‚úì All documents generated. Ready to send to prospect.
                </div>

                <div id="proposal-content" style="margin-top: 20px;"></div>
            </div>

            <!-- OPPORTUNITIES -->
            <div class="card mb-20">
                <h2>üéØ Top Opportunities</h2>
                <div id="opportunities-list"></div>
            </div>

            <!-- DOCUMENTS SECTION -->
            <div class="card">
                <h2>üì¶ Generated Documents</h2>
                <div id="documents-list"></div>
            </div>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="dashboard-view" class="hidden">
            <div class="card mb-20">
                <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üìä Dashboard</h2>
                    <button class="btn btn-secondary btn-small" onclick="app.backToDiscovery()">‚Üê Back to Discovery</button>
                </div>
                <div class="dashboard-grid" id="dashboard-grid">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <div class="card mb-20">
                <h2>üìû Recent Calls</h2>
                <table class="call-log-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Prospect</th>
                            <th>Company</th>
                            <th>Industry</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="call-log-tbody">
                        <!-- Dynamically populated -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- CRM VIEW -->
        <div id="crm-view" class="hidden">
            <div class="card mb-20">
                <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin: 0;">üìá CRM - All Prospects</h2>
                    <div class="flex gap-10">
                        <button class="btn btn-primary btn-small" onclick="app.exportCRMToSheets()">üìä Export to CSV</button>
                        <button class="btn btn-secondary btn-small" onclick="app.backToDiscovery()">‚Üê Back to Discovery</button>
                    </div>
                </div>
                <table class="call-log-table">
                    <thead>
                        <tr>
                            <th>Prospect</th>
                            <th>Company</th>
                            <th>Industry</th>
                            <th>Status</th>
                            <th>Pain</th>
                            <th>Est. Revenue</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="crm-tbody">
                        <!-- Dynamically populated -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="email-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Email Template</h2>
                <button class="modal-close" onclick="app.closeModal('email-modal')">√ó</button>
            </div>
            <div id="email-content" style="white-space: pre-wrap; font-family: monospace; font-size: 13px; line-height: 1.6;"></div>
            <button class="btn btn-primary" onclick="app.copyEmailToClipboard()" style="margin-top: 20px;">Copy to Clipboard</button>
        </div>
    </div>

    <!-- FOLLOW-UP EMAILS VIEW -->
    <div id="followup-view" class="hidden">
        <div class="container">
            <div class="card mb-20">
                <h2>‚úâÔ∏è Automated Follow-Up Emails</h2>
                <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">
                    Select a template based on where the prospect is in your pipeline.
                </p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div class="template-card" onclick="app.useFollowUpTemplate('3day')" style="background: var(--bg-light); padding: 15px; border-radius: 8px; cursor: pointer; border: 1px solid var(--border); transition: all 0.3s;">
                        <h4 style="color: var(--accent); margin-bottom: 8px;">üìÖ 3-Day Follow-Up</h4>
                        <p style="font-size: 12px; color: var(--text-muted);">After sending proposal, no response</p>
                    </div>

                    <div class="template-card" onclick="app.useFollowUpTemplate('7day')" style="background: var(--bg-light); padding: 15px; border-radius: 8px; cursor: pointer; border: 1px solid var(--border); transition: all 0.3s;">
                        <h4 style="color: var(--accent); margin-bottom: 8px;">‚è∞ 7-Day Check-In</h4>
                        <p style="font-size: 12px; color: var(--text-muted);">Still considering, gentle reminder</p>
                    </div>

                    <div class="template-card" onclick="app.useFollowUpTemplate('interested')" style="background: var(--bg-light); padding: 15px; border-radius: 8px; cursor: pointer; border: 1px solid var(--border); transition: all 0.3s;">
                        <h4 style="color: var(--accent); margin-bottom: 8px;">‚úÖ Interested - Book Call</h4>
                        <p style="font-size: 12px; color: var(--text-muted);">They're ready, schedule next step</p>
                    </div>

                    <div class="template-card" onclick="app.useFollowUpTemplate('notready')" style="background: var(--bg-light); padding: 15px; border-radius: 8px; cursor: pointer; border: 1px solid var(--border); transition: all 0.3s;">
                        <h4 style="color: var(--accent); margin-bottom: 8px;">‚è∏Ô∏è Not Ready Yet</h4>
                        <p style="font-size: 12px; color: var(--text-muted);">Timing isn't right, stay in touch</p>
                    </div>

                    <div class="template-card" onclick="app.useFollowUpTemplate('custom')" style="background: var(--bg-light); padding: 15px; border-radius: 8px; cursor: pointer; border: 1px solid var(--border); transition: all 0.3s;">
                        <h4 style="color: var(--accent); margin-bottom: 8px;">‚úèÔ∏è Custom</h4>
                        <p style="font-size: 12px; color: var(--text-muted);">Write your own from scratch</p>
                    </div>
                </div>

                <div id="followUpEditor" class="hidden">
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--accent-light);">Edit Follow-Up Email</h3>
                    <div class="form-group">
                        <label>Subject Line</label>
                        <input type="text" id="followUpSubject" style="width: 100%; padding: 12px; background: var(--bg-light); border: 1px solid var(--border); border-radius: 8px; color: var(--text);">
                    </div>
                    <div class="form-group">
                        <label>Email Body</label>
                        <textarea id="followUpBody" style="width: 100%; min-height: 250px; padding: 12px; background: var(--bg-light); border: 1px solid var(--border); border-radius: 8px; color: var(--text); resize: vertical;"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="app.copyFollowUpEmail()">
                        üìã Copy to Clipboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CALENDAR VIEW -->
    <div id="calendar-view" class="hidden">
        <div class="container">
            <div class="card">
                <h2>üìÖ Book Follow-Up Call</h2>

                <div class="tabs" style="display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 20px;">
                    <button class="tab tab-active" id="calendly-tab-btn" onclick="app.switchCalendarTab('calendly')" style="padding: 12px 20px; background: transparent; border: none; color: var(--accent); cursor: pointer; font-size: 13px; font-weight: 600; border-bottom: 2px solid var(--accent); transition: all 0.3s;">
                        Calendly
                    </button>
                    <button class="tab" id="manual-tab-btn" onclick="app.switchCalendarTab('manual')" style="padding: 12px 20px; background: transparent; border: none; color: var(--text-muted); cursor: pointer; font-size: 13px; font-weight: 600; border-bottom: 2px solid transparent; transition: all 0.3s;">
                        Manual Booking
                    </button>
                </div>

                <div id="calendly-tab-content">
                    <div class="alert alert-info" style="padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--accent); background: rgba(59, 130, 246, 0.1); color: var(--accent);">
                        <strong>Setup:</strong> Add your Calendly link below to enable one-click booking.
                    </div>
                    <div class="form-group">
                        <label>Your Calendly Link</label>
                        <input type="text" id="calendlyLink" placeholder="https://calendly.com/your-username/30min">
                        <button class="btn btn-primary" style="margin-top: 10px;" onclick="app.saveCalendlyLink()">Save Link</button>
                    </div>
                    <div id="calendlyEmbed" style="width: 100%; height: 600px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-top: 20px;"></div>
                </div>

                <div id="manual-tab-content" class="hidden">
                    <div class="form-group">
                        <label>Meeting Date/Time</label>
                        <input type="datetime-local" id="meetingDateTime">
                    </div>
                    <div class="form-group">
                        <label>Duration</label>
                        <select id="meetingDuration">
                            <option value="15">15 minutes</option>
                            <option value="30" selected>30 minutes</option>
                            <option value="45">45 minutes</option>
                            <option value="60">60 minutes</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="app.generateCalendarInvite()">
                        üìÖ Generate .ics File
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AUTO-SAVE INDICATOR -->
    <div id="autosaveIndicator" style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--success);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        display: none;
        font-size: 13px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        align-items: center;
        gap: 8px;
    ">
        <span id="autosaveText">‚úì Saved</span>
    </div>

    <script>
        // Create a queue for app calls until app is ready
        const appQueue = [];
        const appProxy = new Proxy({}, {
            get(target, prop) {
                return function(...args) {
                    if (typeof window.app === 'object' && typeof window.app[prop] === 'function') {
                        return window.app[prop](...args);
                    } else {
                        console.warn(`app.${prop} not ready yet, queueing call`);
                        appQueue.push({ prop, args });
                    }
                };
            }
        });

        // Make app globally accessible through proxy
        window.app = appProxy;

        // APPLICATION STATE
        const app = {
            currentStep: 1,
            totalSteps: 5,
            data: {
                company: {},
                pain: {},
                tools: [],
                metrics: {},
                notes: ''
            },
            crm: [],

            // STEP NAVIGATION
            nextStep() {
                if (this.validateStep(this.currentStep)) {
                    this.saveStepData();
                    this.currentStep++;
                    this.updateUI();
                }
            },

            prevStep() {
                if (this.currentStep > 1) {
                    this.saveStepData();
                    this.currentStep--;
                    this.updateUI();
                }
            },

            validateStep(step) {
                if (step === 1) {
                    const name = document.getElementById('prospect-name').value.trim();
                    const email = document.getElementById('prospect-email').value.trim();
                    const company = document.getElementById('company-name').value.trim();
                    const role = document.getElementById('prospect-role').value;
                    const industry = document.getElementById('industry').value;
                    const size = document.querySelector('input[name="company-size"]:checked');

                    // Email validation regex
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                    if (!name || !email || !company || !role || !industry || !size) {
                        alert('Please fill in all required fields (marked with *)');
                        return false;
                    }

                    if (!emailRegex.test(email)) {
                        alert('Please enter a valid email address');
                        return false;
                    }

                    return true;
                } else if (step === 2) {
                    const state = document.getElementById('current-state').value;
                    const category = document.getElementById('pain-category').value;
                    if (!state || !category) {
                        alert('Please describe current state and select pain category');
                        return false;
                    }
                    return true;
                }
                return true;
            },

            saveStepData() {
                if (this.currentStep === 1) {
                    this.data.company = {
                        prospectName: document.getElementById('prospect-name').value.trim(),
                        prospectEmail: document.getElementById('prospect-email').value.trim(),
                        prospectPhone: document.getElementById('prospect-phone').value.trim(),
                        companyName: document.getElementById('company-name').value.trim(),
                        role: document.getElementById('prospect-role').value,
                        industry: document.getElementById('industry').value,
                        size: document.querySelector('input[name="company-size"]:checked')?.value
                    };
                } else if (this.currentStep === 2) {
                    const checked = Array.from(document.querySelectorAll('#pain-checkboxes input:checked')).map(el => el.value);
                    this.data.pain = {
                        currentState: document.getElementById('current-state').value,
                        category: document.getElementById('pain-category').value,
                        items: checked,
                        rootCause: document.getElementById('root-cause').value
                    };
                } else if (this.currentStep === 3) {
                    this.data.tools = Array.from(document.querySelectorAll('#tools-list .tool-tag')).map(el => el.textContent.replace('√ó', '').trim());
                    this.data.pain.integrationGaps = document.getElementById('integration-gaps').value;
                } else if (this.currentStep === 4) {
                    this.data.metrics = {
                        futureState: document.getElementById('future-state').value,
                        teamSize: parseInt(document.getElementById('team-size').value) || 0,
                        hoursPerWeek: parseInt(document.getElementById('hours-per-week').value) || 0,
                        dealValue: parseInt(document.getElementById('deal-value').value) || 0,
                        volumePerWeek: parseInt(document.getElementById('volume-per-week').value) || 0,
                        revenueAtRisk: parseInt(document.getElementById('revenue-at-risk').value) || 0,
                        severity: parseInt(document.getElementById('severity-slider').value) || 5
                    };
                } else if (this.currentStep === 5) {
                    this.data.notes = document.getElementById('additional-notes').value;
                }
            },

            updateUI() {
                // Hide all steps
                for (let i = 1; i <= this.totalSteps; i++) {
                    document.getElementById(`step-${i}`).classList.add('hidden');
                }

                // Show current step
                document.getElementById(`step-${this.currentStep}`).classList.remove('hidden');

                // Update progress
                const progress = (this.currentStep / this.totalSteps) * 100;
                document.getElementById('progress-fill').style.width = progress + '%';
                document.getElementById('step-counter').textContent = `Step ${this.currentStep}`;

                // Update suggestions based on step
                this.updateSuggestions();

                // Scroll to top
                window.scrollTo(0, 0);
            },

            populatePainCheckboxes() {
                const painLists = {
                    'Lead Generation': [
                        'Slow inbound response time',
                        'Hard to qualify/prioritize leads',
                        'Follow-ups fall through cracks',
                        'Manual data entry from forms',
                        'No pipeline visibility'
                    ],
                    'Sales': [
                        'Sales team wasting time on admin',
                        'Proposals take too long',
                        'Contract/signature delays',
                        'Hard to track deal status'
                    ],
                    'Customer Service': [
                        'Repetitive questions eat time',
                        'Slow response to issues',
                        'Customer frustration',
                        'Knowledge scattered'
                    ],
                    'Operations': [
                        'Manual status updates',
                        'Scheduling/logistics chaos',
                        'Project delays',
                        'No-shows/cancellations',
                        'Slow approvals'
                    ],
                    'Finance': [
                        'Invoice processing is slow',
                        'Manual reconciliation',
                        'Month-end close nightmare',
                        'Data scattered across tools'
                    ],
                    'HR': [
                        'Screening resumes manually',
                        'Repetitive onboarding tasks',
                        'Offer letters need customization',
                        'Employee data scattered'
                    ]
                };

                const category = document.getElementById('pain-category').value;
                const checkboxContainer = document.getElementById('pain-checkboxes');
                checkboxContainer.innerHTML = '';

                if (category && painLists[category]) {
                    painLists[category].forEach((pain, index) => {
                        const div = document.createElement('div');
                        div.className = 'checkbox-item';
                        div.innerHTML = `
                            <input type="checkbox" id="pain-${index}" value="${pain}">
                            <label for="pain-${index}">${pain}</label>
                        `;
                        checkboxContainer.appendChild(div);
                    });
                }
            },

            addTool(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const input = document.getElementById('tool-input');
                    const tool = input.value.trim();

                    if (tool) {
                        const toolsList = document.getElementById('tools-list');
                        const tag = document.createElement('div');
                        tag.className = 'tool-tag';
                        tag.style.cssText = 'background: var(--accent); color: white; padding: 8px 12px; border-radius: 20px; font-size: 12px; display: inline-flex; align-items: center; gap: 8px;';
                        tag.innerHTML = `${tool} <button style="background: none; border: none; color: white; cursor: pointer; font-size: 16px; padding: 0; line-height: 1;" onclick="this.parentElement.remove()">√ó</button>`;
                        toolsList.appendChild(tag);
                        input.value = '';
                    }
                }
            },

            updateSuggestions() {
                const questions = [
                    "Have you tried to solve this problem before? What happened?",
                    "How much time is this costing your team per week?",
                    "What's preventing you from fixing this yourself?",
                    "If we solved this, what could your team do instead?",
                    "Who else is affected by this problem?",
                    "What happens if you don't fix this in the next 6 months?",
                    "How long has this been a problem?",
                    "What's the cost of doing nothing?"
                ];

                const randomQ = questions[Math.floor(Math.random() * questions.length)];
                const sidebar = document.getElementById('questions-sidebar');
                sidebar.innerHTML = `<p style="font-size: 13px; line-height: 1.6; padding: 15px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--accent); border-radius: 6px;">üí¨ "${randomQ}"</p>`;

                // Update patterns
                if (this.currentStep === 2 && this.data.pain.category) {
                    const patterns = document.getElementById('patterns-sidebar');
                    patterns.innerHTML = `<p style="font-size: 13px; line-height: 1.6; padding: 15px; background: rgba(16, 185, 129, 0.1); border-left: 3px solid var(--success); border-radius: 6px;">üîç Pattern detected: <strong>${this.data.pain.category}</strong> challenge. Common solutions include automation, integration, and process redesign.</p>`;
                }
            },

            updateROI() {
                const roi = this.calculateROI();
                const calculator = document.getElementById('roi-calculator');

                if (roi.totalMonthlyImpact > 0) {
                    calculator.innerHTML = `
                        <div style="padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 6px;">
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px;">ESTIMATED IMPACT</p>
                            <p style="font-size: 20px; font-weight: 700; color: var(--success); margin-bottom: 5px;">$${roi.totalMonthlyImpact.toLocaleString()}/mo</p>
                            <p style="font-size: 11px; color: var(--text-muted);">Annual: $${roi.annualSavings.toLocaleString()}</p>
                            <p style="font-size: 11px; color: var(--text-muted); margin-top: 10px;">Payback: ${roi.paybackWeeks.toFixed(1)} weeks</p>
                        </div>
                    `;
                }
            },

            // PROPOSAL GENERATION
            generateProposal() {
                this.saveStepData();

                // Save to CRM
                const roi = this.calculateROI();
                const entry = {
                    date: new Date().toLocaleDateString(),
                    ...this.data.company,
                    pain: this.data.pain.items.join(', '),
                    revenue: roi.annualSavings,
                    status: 'Proposal Sent'
                };
                this.crm.push(entry);
                localStorage.setItem('crm-data', JSON.stringify(this.crm));

                // Show results
                document.getElementById('discovery-flow').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');

                this.renderProposal();
                this.renderOpportunities();
                this.renderDocuments();
            },

            calculateROI() {
                // Initialize metrics if not present
                if (!this.data.metrics) {
                    this.data.metrics = {
                        hoursPerWeek: 0,
                        teamSize: 1,
                        dealValue: 0,
                        volumePerWeek: 0,
                        revenueAtRisk: 0,
                        severity: 5
                    };
                }

                const hoursPerWeek = this.data.metrics.hoursPerWeek || 0;
                const teamSize = this.data.metrics.teamSize || 1;
                const dealValue = this.data.metrics.dealValue || 0;
                const volumePerWeek = this.data.metrics.volumePerWeek || 0;
                const revenueAtRisk = this.data.metrics.revenueAtRisk || 0;

                const hourlyRate = 150;
                const timeSavingsMonthly = hoursPerWeek * 4 * teamSize * hourlyRate;
                const revenueLiftMonthly = (volumePerWeek * dealValue * 0.05) * 4; // Conservative 5% lift
                const revenueRecoveryMonthly = revenueAtRisk;

                const totalMonthlyImpact = timeSavingsMonthly + revenueLiftMonthly + revenueRecoveryMonthly;
                const annualSavings = totalMonthlyImpact * 12;
                const investmentRange = { min: 5000, max: 15000 };
                const paybackWeeks = investmentRange.min / (totalMonthlyImpact / 4);

                return {
                    timeSavingsMonthly,
                    revenueLiftMonthly,
                    revenueRecoveryMonthly,
                    totalMonthlyImpact,
                    annualSavings,
                    investmentRange,
                    paybackWeeks
                };
            },

            renderProposal() {
                const roi = this.calculateROI();
                const html = `
                    <div style="background: var(--bg-light); padding: 25px; border-radius: 8px; line-height: 1.8;">
                        <h3 style="color: var(--accent-light); margin-bottom: 15px;">Executive Summary</h3>

                        <p><strong>Prospect:</strong> ${this.data.company.prospectName} @ ${this.data.company.companyName}</p>
                        <p><strong>Industry:</strong> ${this.data.company.industry}</p>
                        <p><strong>Team Size:</strong> ${this.data.metrics.teamSize} people</p>

                        <h4 style="color: var(--accent); margin-top: 20px; margin-bottom: 10px;">Current Situation</h4>
                        <p>${this.data.pain.currentState || 'Not provided'}</p>

                        <h4 style="color: var(--accent); margin-top: 20px; margin-bottom: 10px;">The Core Problem</h4>
                        <p>${this.data.pain.rootCause || 'Not specified'}</p>

                        <h4 style="color: var(--accent); margin-top: 20px; margin-bottom: 10px;">Your Vision</h4>
                        <p>${this.data.metrics.futureState || 'Not described'}</p>

                        <h4 style="color: var(--accent); margin-top: 20px; margin-bottom: 10px;">Expected Impact</h4>
                        <ul style="margin-left: 20px;">
                            <li>Team time freed: <strong>${(roi.timeSavingsMonthly / (this.data.metrics.teamSize * 150 * 4) || 0).toFixed(1)} hours/week</strong></li>
                            <li>Monthly savings: <strong>$${(roi.totalMonthlyImpact).toLocaleString()}</strong></li>
                            <li>Annual impact: <strong>$${(roi.annualSavings).toLocaleString()}</strong></li>
                            <li>Payback period: <strong>${roi.paybackWeeks.toFixed(1)} weeks</strong></li>
                        </ul>

                        <h4 style="color: var(--accent); margin-top: 20px; margin-bottom: 10px;">Current Tech Stack</h4>
                        <p>${this.data.tools.length > 0 ? this.data.tools.join(', ') : 'Not documented'}</p>

                        <h4 style="color: var(--accent); margin-top: 20px; margin-bottom: 10px;">Integration Gaps</h4>
                        <p>${this.data.pain.integrationGaps || 'Not documented'}</p>

                        <h4 style="color: var(--accent); margin-top: 20px; margin-bottom: 10px;">Investment & Next Steps</h4>
                        <p>Quick Win: <strong>$${roi.investmentRange.min.toLocaleString()} - $${(roi.investmentRange.min * 2).toLocaleString()}</strong> (2-4 weeks)</p>
                        <p>Full Project: <strong>$${roi.investmentRange.min.toLocaleString()} - $${roi.investmentRange.max.toLocaleString()}</strong> (8-12 weeks)</p>

                        <p style="margin-top: 20px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-left: 3px solid var(--success); border-radius: 6px;">
                            <strong>Next Step:</strong> 30-minute tech scoping call to confirm scope, timeline, and investment.
                        </p>
                    </div>
                `;
                document.getElementById('proposal-content').innerHTML = html;
            },

            renderOpportunities() {
                const opportunities = [
                    {
                        rank: 1,
                        title: 'Automate Lead Capture & Routing',
                        impact: 'High',
                        timeline: '2-4 weeks',
                        description: 'Eliminate manual lead entry and auto-route to sales team',
                        metrics: ['12-15 leads/day contacted faster', '+5-8% conversion lift', '10 hours/week freed']
                    },
                    {
                        rank: 2,
                        title: 'Workflow Automation & Integration',
                        impact: 'High',
                        timeline: '4-8 weeks',
                        description: 'Connect your tools so data flows automatically',
                        metrics: ['Eliminate manual data entry', 'Real-time visibility', '8-12 hours/week freed']
                    },
                    {
                        rank: 3,
                        title: 'Smart Process Redesign',
                        impact: 'Medium',
                        timeline: '4-8 weeks',
                        description: 'Streamline operations and reduce friction points',
                        metrics: ['Process efficiency +40-60%', 'Error reduction 80%+', 'Better customer experience']
                    }
                ];

                const html = opportunities.map(opp => `
                    <div class="opportunity">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <div class="opportunity-rank">#${opp.rank}</div>
                            <div>
                                <h3 style="margin: 0 0 5px 0; color: var(--accent-light);">${opp.title}</h3>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <span style="background: var(--bg-light); padding: 6px 12px; border-radius: 20px; font-size: 12px; color: var(--text-muted);">Impact: ${opp.impact}</span>
                                    <span style="background: var(--bg-light); padding: 6px 12px; border-radius: 20px; font-size: 12px; color: var(--text-muted);">Timeline: ${opp.timeline}</span>
                                </div>
                            </div>
                        </div>
                        <p style="font-size: 14px; line-height: 1.6; margin-bottom: 15px; color: var(--text);">${opp.description}</p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            ${opp.metrics.map(m => `
                                <div style="background: var(--bg-lighter); padding: 10px; border-radius: 6px; border-left: 3px solid var(--accent);">
                                    <div style="font-weight: 700; color: var(--success); font-size: 14px;">‚úì ${m}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                document.getElementById('opportunities-list').innerHTML = html;
            },

            renderDocuments() {
                const documents = [
                    { name: 'Proposal Document', desc: 'Full analysis with recommendations', icon: 'üìÑ' },
                    { name: 'Scope of Work', desc: 'Detailed project timeline and deliverables', icon: 'üìã' },
                    { name: 'Contract', desc: 'Master service agreement', icon: 'üìú' },
                    { name: 'ROI Calculator', desc: 'Specific metrics and payback calculation', icon: 'üí∞' }
                ];

                const html = documents.map(doc => `
                    <div class="document-item">
                        <div class="document-info">
                            <h4>${doc.icon} ${doc.name}</h4>
                            <p>${doc.desc}</p>
                        </div>
                    </div>
                `).join('');

                document.getElementById('documents-list').innerHTML = html;

                // Render strategic insights
                this.renderStrategicInsights();
            },

            // STRATEGIC INSIGHTS & LEAD GENERATION
            generateStrategicInsights() {
                const roi = this.calculateROI();
                const readiness = this.calculateAIReadiness();

                return {
                    roi,
                    readiness,
                    insights: this.getPersonalizedInsights(readiness, roi),
                    followUpEmail: this.generateFollowUpEmail(readiness, roi),
                    crmData: this.generateEnhancedCRMData(readiness, roi)
                };
            },

            calculateAIReadiness() {
                // Calculate readiness based on assessment data and discovery answers
                const manualTasks = this.data.pain.items ? this.data.pain.items.length : 0;
                const hasDocumentation = this.data.pain.currentState ? 1 : 0;
                const teamSize = this.data.metrics.teamSize || 1;
                const hasStrategy = this.data.pain.rootCause ? 1 : 0;

                const readinessScore = Math.min(100, (hasDocumentation + hasStrategy) * 25 + (manualTasks * 5));
                const automationPotential = Math.min(100, manualTasks * 15);

                return {
                    readiness: readinessScore,
                    potential: automationPotential,
                    complexity: manualTasks > 5 ? 'High' : manualTasks > 2 ? 'Medium' : 'Low'
                };
            },

            getPersonalizedInsights(readiness, roi) {
                const insights = [];

                // Insight 1: Process Documentation
                if (readiness.readiness < 50) {
                    insights.push({
                        title: '1. Document Your Core Processes (Foundation)',
                        description: 'Before automating, map your key workflows. Create step-by-step documentation of repetitive tasks that waste time. This becomes your automation blueprint.',
                        action: 'Template: Use a simple spreadsheet or Notion to capture: Task ‚Üí Current Time ‚Üí Frequency ‚Üí Bottlenecks',
                        effort: 'Low',
                        impact: 'High'
                    });
                } else {
                    insights.push({
                        title: '1. Audit & Optimize Existing Processes (Foundation)',
                        description: 'Your processes are documented. Now analyze them for inefficiencies. Remove redundant steps before automation to maximize efficiency gains.',
                        action: 'Template: List each process ‚Üí identify time killers ‚Üí propose 3 improvements per process',
                        effort: 'Medium',
                        impact: 'Very High'
                    });
                }

                // Insight 2: Technology Stack
                insights.push({
                    title: '2. Evaluate Your Tech Stack Integration (Infrastructure)',
                    description: 'The biggest gains come from connecting tools. Most companies use 5-10 disconnected systems. Every manual data entry between tools is money leaving the table.',
                    action: 'Audit: List all tools ‚Üí mark which ones should talk to each other ‚Üí identify the highest-value integrations',
                    effort: 'Medium',
                    impact: 'Very High',
                    roi: `$${(roi.revenueLiftMonthly * 12 / 2).toLocaleString()} annual impact from better integration`
                });

                // Insight 3: Team Capability Building
                insights.push({
                    title: '3. Build Internal AI Capability (Team)',
                    description: 'The future belongs to teams that can use AI daily. Invest in training your people on AI tools like ChatGPT, Zapier, and no-code automation.',
                    action: 'Plan: Week 1-2: Tools overview ‚Üí Week 3-4: Build 1st automation together ‚Üí Week 5+: Team applies independently',
                    effort: 'Low-Medium',
                    impact: 'High',
                    savings: `Time freed: ${(roi.timeSavingsMonthly / 160).toFixed(1)} hours/person/month`
                });

                // Insight 4: Quick Wins
                insights.push({
                    title: '4. Identify & Implement Quick Wins (Momentum)',
                    description: 'Don\'t boil the ocean. Start with 1-2 high-impact, low-complexity automations. Build team confidence and demonstrate ROI in 30 days.',
                    action: 'Start with: Email routing, data entry automation, or reporting automation (usually 2-3 week payback)',
                    effort: 'Low',
                    impact: 'High',
                    timeline: '2-3 weeks to full ROI'
                });

                // Insight 5: Strategic Partnership
                insights.push({
                    title: '5. Partner with an AI Automation Expert (Acceleration)',
                    description: 'Most companies leave 60-80% of automation potential on the table. A guided approach saves 6-12 months vs. DIY, and guarantees results.',
                    action: 'Assessment: ROI potential of $${(roi.annualSavings).toLocaleString()}/year. Investment in expert guidance: typically 10-15% of Year 1 savings.',
                    effort: 'Minimal (We handle it)',
                    impact: 'Maximized',
                    callback: true
                });

                return insights;
            },

            generateFollowUpEmail(readiness, roi) {
                const complexity = readiness.complexity;
                const urgency = readiness.potential > 60 ? 'high' : 'medium';

                let subject = '';
                let greeting = `Hi ${this.data.company.prospectName || 'there'},`;

                if (readiness.readiness < 40) {
                    subject = `üöÄ Your AI Automation Roadmap is Ready ‚Äì $${(roi.annualSavings / 12).toLocaleString()}/month potential`;
                } else if (readiness.readiness < 70) {
                    subject = `‚ö° Quick Action Plan: Unlock $${(roi.annualSavings / 12).toLocaleString()}/month from Automation`;
                } else {
                    subject = `üíé Maximizing Your AI Investment: Strategic Opportunities for ${this.data.company.companyName}`;
                }

                const body = `Based on our discovery call about ${this.data.company.companyName}'s automation potential:

**Your Situation:**
- Current Pain: ${this.data.pain.category || 'Manual processes'}
- Team Impact: ${this.data.metrics.teamSize} people spending ${this.data.metrics.hoursPerWeek} hours/week on repetitive work
- Potential Monthly Impact: $${(roi.totalMonthlyImpact).toLocaleString()}

**What We Found:**
‚úì Automation potential: ${readiness.potential}% of your processes
‚úì Quick win timeline: 2-3 weeks
‚úì Full ROI in: ${roi.paybackWeeks.toFixed(1)} weeks

**Next Steps:**
You have two paths forward:

1. **DIY Route:** Use the insights and templates we provided. Most companies see results in 60-90 days.

2. **Guided Partnership:** We handle the implementation. Same timeline, guaranteed results, and you keep your team focused on revenue.

The difference? Companies that partner with us typically achieve 3x faster implementation and unlock 60-80% MORE value than DIY approaches.

Would you be open to a 20-minute conversation about which approach fits ${this.data.company.companyName} best?

Looking forward to your success,
Vaishali Mehmi
AI Automation Consultant`;

                return { subject, body, greeting };
            },

            generateEnhancedCRMData(readiness, roi) {
                return {
                    ...this.data.company,
                    email: this.data.company.prospectEmail || '',
                    scores: {
                        aiReadiness: readiness.readiness,
                        automationPotential: readiness.potential,
                        complexity: readiness.complexity
                    },
                    metrics: {
                        monthlyImpact: roi.totalMonthlyImpact,
                        annualSavings: roi.annualSavings,
                        paybackWeeks: roi.paybackWeeks
                    },
                    insights: this.getPersonalizedInsights(readiness, roi).slice(0, 3).map(i => i.title),
                    timestamp: new Date().toISOString(),
                    status: 'Insights Shared',
                    alertFlag: roi.annualSavings > 50000 ? 'High Priority Lead' : 'Standard Follow-up',
                    followUpDue: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toLocaleDateString()
                };
            },

            renderStrategicInsights() {
                const { roi, readiness, insights, followUpEmail, crmData } = this.generateStrategicInsights();

                // Save enhanced CRM data
                this.crm[this.crm.length - 1] = {
                    ...this.crm[this.crm.length - 1],
                    ...crmData
                };
                localStorage.setItem('crm-data', JSON.stringify(this.crm));

                // Create insights HTML
                const insightsHTML = `
                    <div style="margin-top: 40px; border-top: 2px solid var(--border); padding-top: 30px;">
                        <h3 style="color: var(--accent-light); margin-bottom: 10px; font-size: 24px;">üéØ Your Strategic Path Forward</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 30px; font-size: 15px;">5 proven ways to maximize your AI & automation potential</p>

                        ${insights.map((insight, idx) => `
                            <div style="background: var(--bg-light); border-left: 4px solid ${idx === 4 ? 'var(--accent)' : 'var(--border)'}; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                                <h4 style="color: ${idx === 4 ? 'var(--accent-light)' : 'var(--text-primary)'}; margin-bottom: 10px; font-size: 16px;">${insight.title}</h4>
                                <p style="color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">${insight.description}</p>
                                <div style="display: grid; grid-template-columns: auto auto; gap: 15px; margin-bottom: 12px; font-size: 13px;">
                                    <div><strong>Effort:</strong> ${insight.effort}</div>
                                    <div><strong>Impact:</strong> ${insight.impact}</div>
                                    ${insight.roi ? `<div style="grid-column: 1/-1;"><strong>üí∞ Potential:</strong> ${insight.roi}</div>` : ''}
                                    ${insight.savings ? `<div style="grid-column: 1/-1;"><strong>‚è∞ Savings:</strong> ${insight.savings}</div>` : ''}
                                    ${insight.timeline ? `<div style="grid-column: 1/-1;"><strong>üìÖ Timeline:</strong> ${insight.timeline}</div>` : ''}
                                </div>
                                <p style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 6px; font-size: 13px; color: var(--text); margin-bottom: 12px;"><strong>Action Plan:</strong> ${insight.action}</p>
                                ${insight.callback ? `
                                    <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" data-action="scheduleCallCTA">
                                        üìÖ Schedule Discovery Call ‚Äì Book My Strategy Session
                                    </button>
                                ` : ''}
                            </div>
                        `).join('')}

                        <div style="background: linear-gradient(135deg, rgba(0, 217, 255, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%); border: 2px solid var(--accent); border-radius: 12px; padding: 30px; margin-top: 30px; text-align: center;">
                            <h4 style="color: var(--accent-light); margin-bottom: 15px; font-size: 18px;">Your Potential Annual Automation Impact</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <div style="font-size: 32px; font-weight: 700; color: var(--success); margin-bottom: 5px;">$${(roi.annualSavings).toLocaleString()}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">Annual Savings</div>
                                </div>
                                <div>
                                    <div style="font-size: 32px; font-weight: 700; color: var(--accent); margin-bottom: 5px;">${roi.paybackWeeks.toFixed(1)}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">Weeks to ROI</div>
                                </div>
                                <div>
                                    <div style="font-size: 32px; font-weight: 700; color: var(--accent-light); margin-bottom: 5px;">${readiness.potential}%</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">Automation Potential</div>
                                </div>
                            </div>
                            <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">Ready to unlock this potential? Let's work together.</p>
                            <button class="btn btn-primary" style="width: 100%; padding: 15px;" data-action="scheduleCallCTA">
                                üöÄ Let's Discuss Your AI Transformation
                            </button>
                        </div>
                    </div>
                `;

                // Append to proposal content
                const proposalDiv = document.getElementById('proposal-content');
                if (proposalDiv) {
                    proposalDiv.innerHTML += insightsHTML;
                }

                // Store follow-up email for later use
                this.lastFollowUpEmail = followUpEmail;
                this.lastCRMData = crmData;
            },

            scheduleCallCTA() {
                // Link to your Calendly or booking system
                // Replace CALENDLY_USERNAME with your actual Calendly username or booking URL
                const calendlyUrl = 'https://calendly.com/your-calendly-username/30min';

                // If Calendly URL is not configured, show alert
                if (calendlyUrl.includes('your-calendly-username')) {
                    alert('Booking link not yet configured. Please add your Calendly URL to enable scheduling.');
                    return;
                }

                window.location.href = calendlyUrl;
            },

            downloadProposal() {
                const content = document.getElementById('proposal-content').innerText;
                const blob = new Blob([content], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Proposal-${this.data.company.companyName}-${new Date().toLocaleDateString()}.txt`;
                a.click();
                window.URL.revokeObjectURL(url);
            },

            downloadScope() {
                const scopeText = `SCOPE OF WORK
${this.data.company.companyName}
Prepared: ${new Date().toLocaleDateString()}

EXECUTIVE SUMMARY
${this.data.pain.currentState}

PHASE 1: ASSESSMENT (1-2 weeks)
- Deep dive on current tools and processes
- Identify quick wins vs. strategic projects
- Build detailed implementation plan

PHASE 2: DESIGN (2-3 weeks)
- Design specific workflows for your situation
- Document integrations and automation rules
- Get stakeholder sign-off

PHASE 3: BUILD & DEPLOY (4-8 weeks)
- Implement integrations and automation
- Test end-to-end with your team
- Go live with full support

PHASE 4: OPTIMIZE (Ongoing)
- Monitor key metrics
- Refine workflows based on usage
- Identify next-phase opportunities

DELIVERABLES
‚úì Live working systems ready for daily use
‚úì Trained team
‚úì Documentation
‚úì 2 weeks post-launch support

TIMELINE: 8-12 weeks total
INVESTMENT: $15,000 - $30,000 (depending on scope)

NEXT STEPS
Schedule 30-minute tech scoping call to confirm details.`;

                const blob = new Blob([scopeText], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `SOW-${this.data.company.companyName}.txt`;
                a.click();
                window.URL.revokeObjectURL(url);
            },

            downloadContract() {
                const contractText = `MASTER SERVICE AGREEMENT

This Agreement is entered into between:
Provider: [Your Company Name]
Client: ${this.data.company.companyName}
Date: ${new Date().toLocaleDateString()}

1. SERVICES
Provider will deliver AI and automation consulting services including:
- Discovery and assessment
- Solution design and implementation
- Training and support

2. INVESTMENT
Investment: $15,000 - $30,000 (to be confirmed in scoping call)
Payment Terms: 50% upfront, 50% upon delivery

3. TIMELINE
Project Duration: 8-12 weeks from kickoff
Milestone dates to be confirmed in statement of work

4. DELIVERABLES
- Complete implementation of agreed solutions
- Team training and documentation
- 2 weeks post-launch support

5. TERMS & CONDITIONS
- Work performed in good faith
- Client will provide necessary access and team availability
- Scope changes may affect timeline/investment
- NDA to protect both parties' information

6. CONFIDENTIALITY
Both parties agree to maintain confidentiality of proprietary information.

7. AGREEMENT
By signing below, both parties agree to the terms of this agreement.

Client Signature: _________________________ Date: _________
Provider Signature: ________________________ Date: _________`;

                const blob = new Blob([contractText], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Contract-${this.data.company.companyName}.txt`;
                a.click();
                window.URL.revokeObjectURL(url);
            },

            showEmailTemplate() {
                const email = `Subject: Proposal from our call today ‚Äì ${this.data.company.companyName}

Hi ${this.data.company.prospectName},

Great to talk today. As promised, here's my analysis of where you have the biggest opportunities.

THE SITUATION:
${this.data.pain.currentState}

THE CHALLENGE:
${this.data.pain.rootCause}

YOUR VISION:
${this.data.metrics.futureState}

WHAT WE FOUND:
I identified 3 specific opportunities to save time, improve processes, and free up your team.

Key highlights:
‚Ä¢ Automate lead capture & routing ‚Üí +5-8% conversion lift
‚Ä¢ Integrate tools ‚Üí Eliminate manual data entry
‚Ä¢ Process redesign ‚Üí 40-60% efficiency improvement

INVESTMENT & TIMELINE:
Quick Win (2-4 weeks): $5,000 - $10,000
Full Project (8-12 weeks): $15,000 - $30,000

Full proposal with specific recommendations attached.

NEXT STEP:
Let's lock in a 30-minute tech scoping call to get into implementation details.

[Link to your calendar]

Questions? Happy to clarify anything.

Talk soon,
[Your Name]
[Your Company]
[Your Email]
[Your Phone]`;

                document.getElementById('email-content').textContent = email;
                document.getElementById('email-modal').classList.add('active');
            },

            closeModal(id) {
                document.getElementById(id).classList.remove('active');
            },

            copyEmailToClipboard() {
                const text = document.getElementById('email-content').textContent;
                navigator.clipboard.writeText(text).then(() => {
                    alert('Email copied to clipboard!');
                });
            },

            backToDiscovery() {
                document.getElementById('discovery-flow').classList.remove('hidden');
                document.getElementById('results-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById('crm-view').classList.add('hidden');
            },

            // DASHBOARD & CRM
            showDashboard() {
                document.getElementById('discovery-flow').classList.add('hidden');
                document.getElementById('results-view').classList.add('hidden');
                document.getElementById('crm-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');

                this.loadCRM();
                this.renderDashboard();
            },

            showCRM() {
                document.getElementById('discovery-flow').classList.add('hidden');
                document.getElementById('results-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById('crm-view').classList.remove('hidden');

                this.loadCRM();
                this.renderCRM();
            },

            loadCRM() {
                const saved = localStorage.getItem('crm-data');
                if (saved) {
                    this.crm = JSON.parse(saved);
                }
            },

            renderDashboard() {
                const totalCalls = this.crm.length;
                const totalValue = this.crm.reduce((sum, entry) => sum + (entry.revenue || 0), 0);
                const avgValue = totalCalls > 0 ? totalValue / totalCalls : 0;
                const conversionRate = ((this.crm.filter(e => e.status === 'Proposal Sent').length / totalCalls) * 100 || 0).toFixed(1);

                const html = `
                    <div class="dashboard-card">
                        <h3>Total Discovery Calls</h3>
                        <div class="value">${totalCalls}</div>
                        <div class="subtext">Prospects engaged</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Total Potential Revenue</h3>
                        <div class="value">$${(totalValue / 1000).toFixed(0)}k</div>
                        <div class="subtext">Annual impact estimate</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Avg. Opportunity Value</h3>
                        <div class="value">$${(avgValue / 1000).toFixed(0)}k</div>
                        <div class="subtext">Per prospect</div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Conversion Rate</h3>
                        <div class="value">${conversionRate}%</div>
                        <div class="subtext">Proposals sent</div>
                    </div>
                `;
                document.getElementById('dashboard-grid').innerHTML = html;

                const tbody = document.getElementById('call-log-tbody');
                tbody.innerHTML = this.crm.slice(-10).reverse().map(entry => `
                    <tr>
                        <td>${entry.date}</td>
                        <td>${entry.prospectName || 'N/A'}</td>
                        <td>${entry.companyName || 'N/A'}</td>
                        <td>${entry.industry || 'N/A'}</td>
                        <td><span style="color: var(--success);">‚óè ${entry.status || 'In Progress'}</span></td>
                    </tr>
                `).join('') || '<tr><td colspan="5" style="text-align: center; color: var(--text-muted);">No calls yet</td></tr>';
            },

            renderCRM() {
                const tbody = document.getElementById('crm-tbody');
                tbody.innerHTML = this.crm.map(entry => `
                    <tr>
                        <td>${entry.prospectName || 'N/A'}</td>
                        <td>${entry.companyName || 'N/A'}</td>
                        <td>${entry.industry || 'N/A'}</td>
                        <td><span style="color: var(--success);">‚óè ${entry.status || 'In Progress'}</span></td>
                        <td>${entry.pain || 'Not documented'}</td>
                        <td>$${(entry.revenue || 0).toLocaleString()}</td>
                        <td>${entry.date}</td>
                    </tr>
                `).join('') || '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">No prospects yet</td></tr>';
            },

            exportCRMToSheets() {
                // Generate a CSV export
                const headers = ['Date', 'Prospect', 'Company', 'Industry', 'Pain Points', 'Est. Revenue', 'Status'];
                const rows = this.crm.map(entry => [
                    entry.date,
                    entry.prospectName || '',
                    entry.companyName || '',
                    entry.industry || '',
                    entry.pain || '',
                    entry.revenue || '',
                    entry.status || ''
                ]);

                const csv = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `CRM-Export-${new Date().toLocaleDateString()}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);

                alert('CRM data exported! Import this CSV into Google Sheets:\n1. Go to Google Sheets\n2. Create new sheet\n3. File > Import > Upload file\n4. Select this CSV');
            },

            resetAll() {
                if (confirm('Clear all data and start fresh?')) {
                    localStorage.removeItem('crm-data');
                    this.crm = [];
                    this.currentStep = 1;
                    this.data = {
                        company: {},
                        pain: {},
                        tools: [],
                        metrics: {},
                        notes: ''
                    };
                    this.backToDiscovery();
                    this.updateUI();
                    location.reload();
                }
            },

            // AUTO-SAVE FUNCTIONALITY
            autosaveInterval: null,

            startAutosave() {
                this.autosaveInterval = setInterval(() => {
                    this.autoSave();
                }, 30000); // 30 seconds
            },

            autoSave() {
                // Save current step data
                this.saveStepData();

                // Save to localStorage
                localStorage.setItem('discovery-data', JSON.stringify(this.data));
                localStorage.setItem('discovery-step', this.currentStep);

                // Show indicator
                this.showAutosaveIndicator('saving');
                setTimeout(() => {
                    this.showAutosaveIndicator('saved');
                }, 500);
            },

            showAutosaveIndicator(state) {
                const indicator = document.getElementById('autosaveIndicator');
                const text = document.getElementById('autosaveText');

                if (state === 'saving') {
                    indicator.style.background = 'var(--warning)';
                    text.textContent = 'üíæ Saving...';
                    indicator.style.display = 'flex';
                } else if (state === 'saved') {
                    indicator.style.background = 'var(--success)';
                    text.textContent = '‚úì Saved';
                    indicator.style.display = 'flex';
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 2000);
                }
            },

            // PROGRESSIVE SUMMARY
            updateProgressiveSummary() {
                const summary = document.getElementById('progressiveSummary');
                if (!summary) return;

                let html = '';

                // Company info
                if (this.data.company.companyName) {
                    html += `
                        <div style="margin-bottom: 12px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--accent); border-radius: 4px;">
                            <strong style="display: block; color: var(--accent); font-size: 11px; margin-bottom: 4px; text-transform: uppercase;">Company</strong>
                            <div style="font-size: 13px;">${this.data.company.companyName}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">${this.data.company.industry || 'Industry not specified'}</div>
                        </div>
                    `;
                }

                // Pain points
                if (this.data.pain.currentState) {
                    html += `
                        <div style="margin-bottom: 12px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-left: 3px solid var(--warning); border-radius: 4px;">
                            <strong style="display: block; color: var(--warning); font-size: 11px; margin-bottom: 4px; text-transform: uppercase;">Current Pain</strong>
                            <div style="font-size: 13px;">${this.data.pain.currentState.substring(0, 100)}${this.data.pain.currentState.length > 100 ? '...' : ''}</div>
                        </div>
                    `;
                }

                // Tools
                if (this.data.tools && this.data.tools.length > 0) {
                    html += `
                        <div style="margin-bottom: 12px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--accent); border-radius: 4px;">
                            <strong style="display: block; color: var(--accent); font-size: 11px; margin-bottom: 4px; text-transform: uppercase;">Tech Stack</strong>
                            <div style="font-size: 13px;">${this.data.tools.slice(0, 3).join(', ')}${this.data.tools.length > 3 ? '...' : ''}</div>
                        </div>
                    `;
                }

                // Metrics
                if (this.data.metrics.teamSize) {
                    html += `
                        <div style="margin-bottom: 12px; padding: 12px; background: rgba(16, 185, 129, 0.1); border-left: 3px solid var(--success); border-radius: 4px;">
                            <strong style="display: block; color: var(--success); font-size: 11px; margin-bottom: 4px; text-transform: uppercase;">Impact</strong>
                            <div style="font-size: 13px;">${this.data.metrics.teamSize} people ¬∑ ${this.data.metrics.hoursPerWeek || 0} hrs/week</div>
                        </div>
                    `;
                }

                summary.innerHTML = html || '<p style="font-size: 13px; color: var(--text-muted);">Summary will build as you fill in the form...</p>';

                // Update ROI if metrics exist
                this.updateROISummary();
            },

            updateROISummary() {
                const roiDiv = document.getElementById('roiSummary');
                if (!roiDiv) return;

                if (this.data.metrics.hoursPerWeek && this.data.metrics.teamSize) {
                    const roi = this.calculateROI();
                    roiDiv.innerHTML = `
                        <div style="padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 6px;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--success); margin-bottom: 5px;">
                                $${roi.totalMonthlyImpact.toLocaleString()}<span style="font-size: 14px;">/mo</span>
                            </div>
                            <div style="font-size: 11px; color: var(--text-muted);">
                                Annual: $${roi.annualSavings.toLocaleString()}<br>
                                Payback: ${roi.paybackWeeks.toFixed(1)} weeks
                            </div>
                        </div>
                    `;
                } else {
                    roiDiv.innerHTML = '<p style="font-size: 13px; color: var(--text-muted);">Fill in metrics to see ROI...</p>';
                }
            },

            // PDF GENERATION
            async downloadProposalPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Title Page
                doc.setFontSize(28);
                doc.setTextColor(59, 130, 246);
                doc.text('Proposal', 20, 30);

                doc.setFontSize(18);
                doc.setTextColor(30, 41, 59);
                doc.text(this.data.company.companyName || 'Client Company', 20, 45);

                doc.setFontSize(12);
                doc.setTextColor(148, 163, 184);
                doc.text('Prepared: ' + new Date().toLocaleDateString(), 20, 55);
                doc.text('AI Automation Consultant', 20, 62);

                // Executive Summary
                let y = 80;
                doc.setFontSize(16);
                doc.setTextColor(59, 130, 246);
                doc.text('Executive Summary', 20, y);

                y += 10;
                doc.setFontSize(11);
                doc.setTextColor(30, 41, 59);
                doc.text(`Company: ${this.data.company.companyName}`, 20, y);
                y += 7;
                doc.text(`Industry: ${this.data.company.industry}`, 20, y);
                y += 7;
                doc.text(`Team Size: ${this.data.metrics.teamSize || 'N/A'} people`, 20, y);

                // Current Situation
                y += 15;
                doc.setFontSize(14);
                doc.setTextColor(59, 130, 246);
                doc.text('Current Situation', 20, y);

                y += 8;
                doc.setFontSize(10);
                doc.setTextColor(30, 41, 59);
                const currentState = doc.splitTextToSize(this.data.pain.currentState || 'Not documented', 170);
                doc.text(currentState, 20, y);
                y += currentState.length * 5 + 5;

                // Core Problem
                if (this.data.pain.rootCause) {
                    doc.setFontSize(14);
                    doc.setTextColor(59, 130, 246);
                    doc.text('Core Problem', 20, y);
                    y += 8;
                    doc.setFontSize(10);
                    doc.setTextColor(30, 41, 59);
                    const rootCause = doc.splitTextToSize(this.data.pain.rootCause, 170);
                    doc.text(rootCause, 20, y);
                    y += rootCause.length * 5 + 5;
                }

                // Expected Impact
                y += 10;
                doc.setFontSize(14);
                doc.setTextColor(16, 185, 129);
                doc.text('Expected Impact', 20, y);

                y += 8;
                doc.setFontSize(10);
                doc.setTextColor(30, 41, 59);
                const roi = this.calculateROI();
                doc.text(`Monthly Savings: $${roi.totalMonthlyImpact.toLocaleString()}`, 20, y);
                y += 6;
                doc.text(`Annual Impact: $${roi.annualSavings.toLocaleString()}`, 20, y);
                y += 6;
                doc.text(`Payback Period: ${roi.paybackWeeks.toFixed(1)} weeks`, 20, y);

                // Investment
                y += 15;
                doc.setFontSize(14);
                doc.setTextColor(59, 130, 246);
                doc.text('Investment & Timeline', 20, y);

                y += 8;
                doc.setFontSize(10);
                doc.setTextColor(30, 41, 59);
                doc.text(`Quick Win: $${roi.investmentRange.min.toLocaleString()} - $${(roi.investmentRange.min * 2).toLocaleString()} (2-4 weeks)`, 20, y);
                y += 6;
                doc.text(`Full Project: $${roi.investmentRange.min.toLocaleString()} - $${roi.investmentRange.max.toLocaleString()} (8-12 weeks)`, 20, y);

                // Next Steps
                y += 15;
                doc.setFontSize(14);
                doc.setTextColor(59, 130, 246);
                doc.text('Next Steps', 20, y);

                y += 8;
                doc.setFontSize(10);
                doc.setTextColor(30, 41, 59);
                doc.text('1. Review this proposal', 20, y);
                y += 6;
                doc.text('2. Schedule 30-minute tech scoping call', 20, y);
                y += 6;
                doc.text('3. Confirm scope and timeline', 20, y);
                y += 6;
                doc.text('4. Begin implementation', 20, y);

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(148, 163, 184);
                doc.text('¬© ' + new Date().getFullYear() + ' | AI Automation Consultant', 20, 285);

                // Save
                doc.save(`Proposal-${this.data.company.companyName}-${new Date().toLocaleDateString()}.pdf`);
            },

            async downloadScopePDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(24);
                doc.setTextColor(59, 130, 246);
                doc.text('Scope of Work', 20, 30);

                doc.setFontSize(14);
                doc.setTextColor(30, 41, 59);
                doc.text(this.data.company.companyName || 'Client Company', 20, 45);

                let y = 60;
                doc.setFontSize(12);
                doc.text('Project Phases', 20, y);

                y += 10;
                doc.setFontSize(10);
                doc.text('Phase 1: Discovery & Planning (Weeks 1-2)', 20, y);
                y += 10;
                doc.text('Phase 2: Quick Wins Implementation (Weeks 3-4)', 20, y);
                y += 10;
                doc.text('Phase 3: Full Automation Rollout (Weeks 5-10)', 20, y);
                y += 10;
                doc.text('Phase 4: Training & Handoff (Weeks 11-12)', 20, y);

                doc.save(`SOW-${this.data.company.companyName}-${new Date().toLocaleDateString()}.pdf`);
            },

            async downloadContractPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(24);
                doc.setTextColor(59, 130, 246);
                doc.text('Service Agreement', 20, 30);

                doc.setFontSize(12);
                doc.setTextColor(30, 41, 59);
                doc.text(`Client: ${this.data.company.companyName}`, 20, 50);
                doc.text(`Contractor: [Your Company Name]`, 20, 58);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 66);

                doc.save(`Contract-${this.data.company.companyName}-${new Date().toLocaleDateString()}.pdf`);
            },

            // FOLLOW-UP EMAIL TEMPLATES
            followUpTemplates: {
                '3day': {
                    subject: 'Following up on our call - {company}',
                    body: `Hi {prospect},\n\nHope you're well! I wanted to follow up on the proposal I sent 3 days ago.\n\nQuick recap:\n- Current challenge: {pain}\n- Estimated monthly impact: ${this.data.metrics.teamSize ? '$' + this.calculateROI().totalMonthlyImpact.toLocaleString() : '[ROI]'}/month\n- Timeline: 8-12 weeks\n\nAny questions? Happy to jump on a quick call.\n\nBest,\n[Your Name]`
                },
                '7day': {
                    subject: 'Checking in - {company}',
                    body: `Hi {prospect},\n\nJust checking in! I know you're busy evaluating options.\n\nIs there anything I can clarify about the proposal?\n\nBest,\n[Your Name]`
                },
                'interested': {
                    subject: `Let's schedule your tech scoping call - {company}`,
                    body: `Hi {prospect},\n\nGreat to hear you're interested! Let's schedule a 30-minute tech scoping call.\n\nHere's my calendar: [YOUR CALENDLY LINK]\n\nLooking forward to it!\n\nBest,\n[Your Name]`
                },
                'notready': {
                    subject: 'Staying in touch - {company}',
                    body: `Hi {prospect},\n\nThanks for letting me know the timing isn't right yet. I completely understand.\n\nI'll check back in 3 months. In the meantime, feel free to reach out if anything changes.\n\nBest,\n[Your Name]`
                },
                'custom': {
                    subject: '',
                    body: ''
                }
            },

            useFollowUpTemplate(type) {
                const template = this.followUpTemplates[type];
                const roi = this.calculateROI();

                // Replace placeholders
                let subject = template.subject
                    .replace('{company}', this.data.company.companyName || '[Company Name]')
                    .replace('{prospect}', this.data.company.prospectName || '[Prospect Name]');

                let body = template.body
                    .replace('{company}', this.data.company.companyName || '[Company Name]')
                    .replace('{prospect}', this.data.company.prospectName || '[Prospect Name]')
                    .replace('{pain}', (this.data.pain.currentState || 'Your challenge').substring(0, 100));

                document.getElementById('followUpSubject').value = subject;
                document.getElementById('followUpBody').value = body;
                document.getElementById('followUpEditor').classList.remove('hidden');

                // Scroll to editor
                document.getElementById('followUpEditor').scrollIntoView({ behavior: 'smooth' });
            },

            copyFollowUpEmail() {
                const subject = document.getElementById('followUpSubject').value;
                const body = document.getElementById('followUpBody').value;
                const fullEmail = `Subject: ${subject}\n\n${body}`;

                navigator.clipboard.writeText(fullEmail).then(() => {
                    alert('‚úÖ Email copied to clipboard!');
                });
            },

            showFollowUpView() {
                document.getElementById('discovery-flow').classList.add('hidden');
                document.getElementById('results-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById('crm-view').classList.add('hidden');
                document.getElementById('calendar-view').classList.add('hidden');
                document.getElementById('followup-view').classList.remove('hidden');
            },

            // CALENDAR INTEGRATION
            saveCalendlyLink() {
                const link = document.getElementById('calendlyLink').value;
                localStorage.setItem('calendly-link', link);
                this.loadCalendlyEmbed(link);
                alert('‚úÖ Calendly link saved!');
            },

            loadCalendlyEmbed(link) {
                if (!link) {
                    link = localStorage.getItem('calendly-link');
                }
                if (link) {
                    document.getElementById('calendlyEmbed').innerHTML =
                        `<iframe src="${link}" width="100%" height="600" frameborder="0"></iframe>`;
                }
            },

            switchCalendarTab(tab) {
                const calendlyBtn = document.getElementById('calendly-tab-btn');
                const manualBtn = document.getElementById('manual-tab-btn');
                const calendlyContent = document.getElementById('calendly-tab-content');
                const manualContent = document.getElementById('manual-tab-content');

                if (tab === 'calendly') {
                    calendlyBtn.style.borderBottomColor = 'var(--accent)';
                    calendlyBtn.style.color = 'var(--accent)';
                    manualBtn.style.borderBottomColor = 'transparent';
                    manualBtn.style.color = 'var(--text-muted)';
                    calendlyContent.classList.remove('hidden');
                    manualContent.classList.add('hidden');
                    this.loadCalendlyEmbed();
                } else {
                    manualBtn.style.borderBottomColor = 'var(--accent)';
                    manualBtn.style.color = 'var(--accent)';
                    calendlyBtn.style.borderBottomColor = 'transparent';
                    calendlyBtn.style.color = 'var(--text-muted)';
                    manualContent.classList.remove('hidden');
                    calendlyContent.classList.add('hidden');
                }
            },

            generateCalendarInvite() {
                const datetime = document.getElementById('meetingDateTime').value;
                const duration = document.getElementById('meetingDuration').value;

                if (!datetime) {
                    alert('Please select a date and time');
                    return;
                }

                const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Discovery Pro//Calendar//EN
BEGIN:VEVENT
UID:${Date.now()}@discoverypro.com
DTSTAMP:${new Date().toISOString().replace(/[-:]/g, '').split('.')[0]}Z
DTSTART:${datetime.replace(/[-:]/g, '')}00
DURATION:PT${duration}M
SUMMARY:Tech Scoping Call - ${this.data.company.companyName}
DESCRIPTION:Follow-up call to discuss AI automation project details
END:VEVENT
END:VCALENDAR`;

                const blob = new Blob([icsContent], { type: 'text/calendar' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `meeting-${this.data.company.companyName}-${new Date().toLocaleDateString()}.ics`;
                a.click();
                URL.revokeObjectURL(url);

                alert('‚úÖ Calendar invite generated!');
            },

            showCalendarView() {
                document.getElementById('discovery-flow').classList.add('hidden');
                document.getElementById('results-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.add('hidden');
                document.getElementById('crm-view').classList.add('hidden');
                document.getElementById('followup-view').classList.add('hidden');
                document.getElementById('calendar-view').classList.remove('hidden');
            }
        };

        // Properly initialize window.app with the real app object
        window.app = app;

        // Process any queued calls
        appQueue.forEach(({ prop, args }) => {
            if (typeof app[prop] === 'function') {
                try {
                    app[prop](...args);
                } catch (err) {
                    console.error(`Error processing queued call app.${prop}:`, err);
                }
            }
        });

        // INITIALIZE
        window.addEventListener('load', () => {
            app.loadCRM();

            // Load scorecard data if coming from scorecard assessment
            const params = new URLSearchParams(window.location.search);
            if (params.has('fromScorecard')) {
                const assessmentResults = sessionStorage.getItem('assessmentResults');
                if (assessmentResults) {
                    try {
                        const scores = JSON.parse(assessmentResults);
                        // Display scorecard context
                        const scorecardBanner = document.createElement('div');
                        scorecardBanner.style.cssText = 'background: linear-gradient(135deg, #00d9ff 0%, #0066cc 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center;';
                        scorecardBanner.innerHTML = `
                            <div style="font-weight: 600; margin-bottom: 10px;">üìä Your AI Readiness Scores</div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; font-size: 14px;">
                                <div><strong>AI Readiness:</strong> ${scores.aiReadiness}%</div>
                                <div><strong>Manual Processes:</strong> ${scores.manualProcesses}%</div>
                                <div><strong>Automation Upside:</strong> ${scores.automationUpside}%</div>
                            </div>
                        `;
                        const discoveryFlow = document.getElementById('discovery-flow');
                        if (discoveryFlow) {
                            discoveryFlow.insertBefore(scorecardBanner, discoveryFlow.firstChild);
                        }
                    } catch (e) {
                        console.error('Error loading scorecard data:', e);
                    }
                }
            }

            app.updateUI();
            app.startAutosave(); // Start auto-save
            app.updateProgressiveSummary(); // Initial summary update

            // Setup button event delegation for all data-action buttons
            document.addEventListener('click', (e) => {
                const button = e.target.closest('[data-action]');
                if (!button) return;

                const action = button.getAttribute('data-action');
                if (action && typeof app[action] === 'function') {
                    e.preventDefault();
                    e.stopPropagation();
                    try {
                        app[action]();
                    } catch (err) {
                        console.error(`Error calling app.${action}():`, err);
                        alert(`Error: ${err.message}`);
                    }
                }
            });

            // Setup nav button handlers with proper ID matching
            setTimeout(() => {
                document.getElementById('btn-dashboard')?.addEventListener('click', () => app.showDashboard());
                document.getElementById('btn-crm')?.addEventListener('click', () => app.showCRM());
                document.getElementById('btn-followup')?.addEventListener('click', () => app.showFollowUpView());
                document.getElementById('btn-calendar')?.addEventListener('click', () => app.showCalendarView());
                document.getElementById('btn-reset')?.addEventListener('click', () => app.resetAll());
            }, 100);
        });

        // AUTO-UPDATE ROI AND PROGRESSIVE SUMMARY
        document.addEventListener('input', (e) => {
            if (app.currentStep === 4) {
                app.updateROI();
            }
            app.updateProgressiveSummary(); // Update summary on any input
        });

        document.addEventListener('change', (e) => {
            app.updateProgressiveSummary(); // Update summary on any change
        });
    </script>
</body>
</html>
